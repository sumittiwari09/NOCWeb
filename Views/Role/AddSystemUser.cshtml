@using NewZapures_V2.Models
@{
    ViewBag.Title = "Add System User";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var loggedInUserType = (string)ViewBag.userType;

    var dept = (List<Dropdown>)ViewBag.document;
    var districtList = (List<Dropdown>)ViewBag.districts;
}
<link href="~/Content/select2/css/select2.css" rel="stylesheet" />

@if (loggedInUserType == "4")
{
    <div style="display: grid;color:red;place-content: center;height: 100vh;font-size: 35px;">You dont have enough permission to view this page please contact to admin</div>
}
else
{
    <div class="row">
        <div class="col-sm-12">
            <div class="page-title-box">
                <div class="float-right">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">NOC</li>
                        <li class="breadcrumb-item active">@ViewBag.Title</li>
                    </ol>
                </div>
                <h4 class="page-title">@ViewBag.Title</h4>
            </div><!--end page-title-box-->
        </div><!--end col-->
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    @using (Html.BeginForm("Savesystemuserdetails", "Role", FormMethod.Post, new { enctype = "multipart/form-data" }))
                    {
                        <div class="row">
                            <div class="col-lg-12 row" style="margin-left: -12px;">
                                <div class="form-group col-lg-4">
                                    <label for="example-text-input" class="col-sm-12" style="margin-left:-10px">Enter SSO ID</label>
                                    <div>
                                        <input class="form-control col-sm-12" type="text" autocomplete="off" id="txtFullName" name="FirstName">
                                    </div>
                                </div>

                                <div class="form-group col-lg-4">
                                    <label for="example-text-input" class="col-sm-6" style="margin-left:-10px">Select District</label>
                                    <div>
                                        <select id="ddldistrict" class="form-control" name="DistrictId">
                                            <option value="0">Select District</option>
                                            @{
                                                if (districtList != null)
                                                {
                                                    foreach (var item in districtList)
                                                    {
                                                        <option value=@item.Id>@item.Text</option>
                                                    }
                                                }
                                            }
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-group col-lg-4">
                                    <label for="example-text-input" class="col-sm-6" style="margin-left:-10px">Select Tehsil</label>
                                    <div>
                                        <select id="ddltehsil" class="form-control" name="CityId">
                                        </select>
                                    </div>
                                </div>

                               
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-12 row" style="margin-left: -12px;">

                                <div class="form-group col-lg-4">
                                    <label for="example-text-input" class="col-sm-12" style="margin-left:-10px">Mobile Number</label>
                                    <div>
                                        <input class="form-control col-sm-12" type="text" autocomplete="off" oninput="numberOnly(this.id);" maxlength="10" name="MobileNumber" id="txtMobileNumber">
                                    </div>
                                </div>

                                <div class="form-group col-lg-4">
                                    <label for="example-text-input" class="col-sm-12" style="margin-left:-10px">Email</label>
                                    <div>
                                        <input class="form-control col-sm-12" type="text" autocomplete="off" id="txtEmail" name="EmailId" oninput="FillUserName(this.id)">
                                    </div>
                                </div>

                                <div class="form-group col-lg-4">
                                    <label for="example-text-input" class="col-sm-6" style="margin-left:-10px">Select Department</label>
                                    <div>
                                        <select id="ddlrole" class="form-control" name="Type">
                                            @{
                                                if (dept != null)
                                                {
                                                    foreach (var item in dept)
                                                    {
                                                        <option value=@item.Id>@item.Text</option>
                                                    }
                                                }
                                            }
                                        </select>
                                    </div>
                                </div>





                               

                            </div>
                        </div>


                        <div class="row">
                            <div class="col-lg-12 row" style="margin-left: -12px;">
                                <div class="form-group col-lg-4">
                                    <label for="example-text-input" class="col-sm-6" style="margin-left:-10px">Select Role Group</label>
                                    <div>
                                        <select id="RoleId" class="form-control" name="RoleId">
                                        </select>
                                    </div>
                                </div>

                                @*<div class="form-group col-lg-4">
                                    <label for="example-text-input" class="col-sm-8" style="margin-left:-10px">Username</label>
                                    <div>
                                        <input class="form-control col-sm-12" type="text" autocomplete="off" id="txtUsername" name="EmailId" readonly>
                                    </div>
                                </div>

                                <div class="form-group col-lg-4">
                                    <label for="example-text-input" class="col-sm-8" style="margin-left:-10px">Password</label>
                                    <div>
                                        <input class="form-control col-sm-12" type="password" autocomplete="off" id="txtPassword" name="Password">
                                        <span id="withoutslash-login" style="display: none; top: -26px; position: relative; place-content: end; margin-right: 10px; align-items: center; width: fit-content; left: 29rem; ">
                                            <i class="fa fa-eye EyeIcon" id="logineye" style="color:black!important" onclick="revealPassword(this,'txtPassword')"></i>
                                        </span>

                                        <span id="withslash-login" style="top: -26px; position: relative; display: flex; place-content: end; margin-right: 10px; align-items: center; width: fit-content; left: 29rem;">
                                            <i class="fa fa-eye-slash EyeIcon" id="logineye" onclick="revealPassword(this,'txtPassword')"></i>
                                        </span>
                                    </div>
                                </div>*@

                                <div class="form-group col-lg-offset-6 col-lg-2">
                                    <label for="example-text-input" class="col-sm-12" style="margin-left:-10px">&nbsp;</label>
                                    <div>
                                        <button type="button" class="btn btn-gradient-primary waves-effect waves-light" id="btnSave" onclick="CheckValidation()">Activate User Button</button>
                                        <button type="submit" id="btnsubmitDetails" style="display:none"></button>
                                    </div>
                                </div>
                            </div>


                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

<script src="~/Content/jquery/jquery.js"></script>
<script src="~/Content/select2/js/select2.js"></script>
<script src="~/Content/globalDomain.js"></script>

<script>

    $(document).ready(function () {
        $("#ddlrole").select2();
        $("#RoleId").select2();
        $("#ddldistrict").select2();
        BindRole();


        $("#ddldistrict").change(function () {
            var distID = $(this).val();
            BindTehsil(distID);

        });



        $('#txtMobileNumber').blur(function () {
            if ($("#txtMobileNumber").val().length > 0) {
                if ($("#txtMobileNumber").val().substr(0, 1) == 0 || $("#txtMobileNumber").val().length < 10) {
                    Swal.fire({
                        position: 'center',
                        icon: 'error',
                        title: '<div><h4><b>Mobile No</b> Length Must be <b>10 Digits</b> long and should start with 1 or greater</h4></div>',
                        allowOutsideClick: false,
                        showCloseButton: true,
                        showConfirmButton: false,

                    });
                    $("#txtMobileNumber").val('');
                }
                else {
                    CheckUserMobile($("#txtMobileNumber").val())
                }
            }
        })

        $('#txtPassword').blur(function () {
            if ($("#txtPassword").val().length > 0) {
                if ($("#txtPassword").val().length < 6) {
                    Swal.fire({
                        position: 'center',
                        icon: 'error',
                        title: '<div>Password Must be 6 charecter long</div>',
                        allowOutsideClick: false,
                        showCloseButton: true,
                        showConfirmButton: false,

                    });
                    $("#txtPassword").val('');
                }
            }
        })

        $('#txtEmail').blur(function () {
            if ($("#txtEmail").val().length > 0) {
                if (!isValidEmailAddress($("#txtEmail").val())) {
                    Swal.fire({
                        position: 'center',
                        icon: 'error',
                        title: `"${$("#txtEmail").val()}" Is not valid, Please Enter Valid Email Address`,
                        allowOutsideClick: false,
                        showCloseButton: true,
                        showConfirmButton: false,
                    });
                    $("#txtEmail").val('');
                    $('#txtUsername').val('');
                }
                else {

                    CheckUserEmailAddress($('#txtEmail').val());
                }
            }
        })


         var isuserExists = '@TempData["IsUserDetailsExists"]'
        var message = '@TempData["msg"]'
        if (isuserExists == 1 && message.length> 0) {
                Swal.fire({
                    position: 'center',
                    icon: 'error',
                    title: message,
                    allowOutsideClick: false,
                    showCloseButton: true,
                    showConfirmButton: false,

                });
        }
        if (isuserExists == 0 && message.length> 0) {
                Swal.fire({
                    position: 'center',
                    icon: 'success',
                    title: message,
                    allowOutsideClick: false,
                    showCloseButton: true,
                    showConfirmButton: false,

                });
            }

    });
    function isValidEmailAddress(email) {
      var regex = /^([a-zA-Z0-9_.+-])+\@@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
    return regex.test(email);
}

    function numberOnly(id) {
        // Get element by id which passed as parameter within HTML element event
        var element = document.getElementById(id);
        // This removes any other character but numbers as entered by user
        element.value = element.value.replace(/[^0-9]/gi, "");
    }

    function FillUserName(item) {

        //var d = $('#' + item).val();
        //console.log(d);

        //$('#txtUsername').val(d);

    }


    function CheckValidation() {

        var btnText = $('#btnSave').html();
        $('#btnSave').html('');
        $('#btnSave').html(' <i class="fas fa fa-spinner fa-pulse ml-1"></i> ' + btnText);
        $('#btnSave').css('cursor', 'wait');

        var status = true;

        var FirstName = $('#txtFullName').val().trim();
        var MobileNumber = $('#txtMobileNumber').val().trim();
        var Password = $('#txtPassword').val();
        var Email = $('#txtEmail').val().trim();
        var Type = $('#ddlrole option:selected').val();
        var RoleId = $('#RoleId option:selected').val();



        if (FirstName.length <= 0) {
            Swal.fire({
                position: 'center',
                icon: 'error',
                title: 'SSO ID Required...!',
                allowOutsideClick: false,
                showCloseButton: false,
                showConfirmButton: false,
                timer: 2000,
            })
            $('#txtFullName').focus();
            $('#btnSave').html('Activate User Button');
            $('#btnSave').css('cursor', 'pointer');

            status = false;
        }
        else if (MobileNumber.length <= 0) {
            Swal.fire({
                position: 'center',
                icon: 'error',
                title: 'Mobile Number Required...!',
                allowOutsideClick: false,
                showCloseButton: false,
                showConfirmButton: false,
                timer: 2000,
            })
            $('#txtMobileNumber').focus();
            $('#btnSave').html('Activate User Button');
            $('#btnSave').css('cursor', 'pointer');
            status = false;
        }
        else if (Email.length <= 0) {
            Swal.fire({
                position: 'center',
                icon: 'error',
                title: 'Email Address Required...!',
                allowOutsideClick: false,
                showCloseButton: false,
                showConfirmButton: false,
                timer: 2000,
            })
            $('#txtEmail').focus();
            $('#btnSave').html('Activate User Button');
            $('#btnSave').css('cursor', 'pointer');
            status = false;
        }

        else if (Type== 0) {
            Swal.fire({
                position: 'center',
                icon: 'error',
                title: 'Please Select Role...!',
                allowOutsideClick: false,
                showCloseButton: false,
                showConfirmButton: false,
                timer: 2000,
            })
            $('#ddlrole').focus();
            $('#btnSave').html('Activate User Button');
            $('#btnSave').css('cursor', 'pointer');
            status = false;
        }
        else if (RoleId == 0) {
            Swal.fire({
                position: 'center',
                icon: 'error',
                title: 'Please Select Group...!',
                allowOutsideClick: false,
                showCloseButton: false,
                showConfirmButton: false,
                timer: 2000,
            })
            $('#RoleId').focus();
            $('#btnSave').html('Activate User Button');
            $('#btnSave').css('cursor', 'pointer');
            status = false;
        }
        //else if (Password.length <= 0) {
        //    Swal.fire({
        //        position: 'center',
        //        icon: 'error',
        //        title: 'Password Required...!',
        //        allowOutsideClick: false,
        //        showCloseButton: false,
        //        showConfirmButton: false,
        //        timer: 2000,
        //    })
        //    $('#txtPassword').focus();
        //    $('#btnSave').html('Activate User Button');
        //    $('#btnSave').css('cursor', 'pointer');
        //    status = false;
        //}

        if (status) {
            $('#btnsubmitDetails').click();
        }
    }


    function CheckUserMobile(mobileNumber) {
        var m = mobileNumber;

        if (m.length > 0) {
            var validationRequestModel = {
                "Email": mobileNumber,
                "Password": "",
                "Type": 'UserCheck'
            }

            var d = JSON.stringify(validationRequestModel);
            console.log(d);
            $.ajax({
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                url: GetglobalDomain()+ "/LoginSignup/ValidateUser",
                dataType: 'json',
                type: 'Post',
                cache: false,
                data: JSON.stringify(validationRequestModel),
                success: function (data) {
                    console.log('ajax');
                    console.log(data);

                    if (data.StatusCode == 1 && data.Message == "User Details Exists") {
                        var d = `"${mobileNumber}" is Already Registered, Please Use Different Mobile Number`;
                        Swal.fire({
                            position: 'center',
                            icon: 'error',
                            title: d,
                            allowOutsideClick: false,
                            showCloseButton: true,
                            showConfirmButton: false,

                        });
                        $("#txtMobileNumber").val('');
                    }
                },
                error: function (d) {
                    console.log(d);
                }
            });
        }
    }

    function revealPassword(sender, itemId) {

        var formId = sender.id.replace('eye', '');
        var type = $('#' + itemId).attr('type');
        if (type == 'password') {


            console.log('inside password type')
            $('#' + itemId).attr('type', 'text');

            $('#withslash-' + formId).css('display', 'none');
            $('#withoutslash-' + formId).css('display', 'flex');

        }
        if (type == 'text') {
            console.log('inside text type')
            $('#' + itemId).attr('type', 'password');
            $('#withslash-' + formId).css('display', 'flex');
            $('#withoutslash-' + formId).css('display', 'none');
        }
    }

    function CheckUserEmailAddress(EmailAddress) {
        var m = EmailAddress;

        if (m.length > 0) {
            var validationRequestModel = {
                "Email": EmailAddress,
                "Password": "",
                "Type": 'UserCheck'
            }

            var d = JSON.stringify(validationRequestModel);
            console.log(d);
            $.ajax({
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                url: GetglobalDomain() + "/LoginSignup/ValidateUser",
                dataType: 'json',
                type: 'Post',
                cache: false,
                data: JSON.stringify(validationRequestModel),
                success: function (data) {
                    console.log('ajax');
                    console.log(data);

                    if (data.StatusCode == 1 && data.Message == "User Details Exists") {
                        var d = `"${EmailAddress}" Is Already Registered`;
                        Swal.fire({
                            position: 'center',
                            icon: 'error',
                            title: d,
                            allowOutsideClick: false,
                            showCloseButton: true,
                            showConfirmButton: false,
                        });
                        $("#txtEmail").val('');
                        $('#txtUsername').val('');
                    }
                },
                error: function (d) {
                    console.log(d);
                }
            });
        }
    }

    function BindRole() {
        debugger;
        var strHTML = "";


        var Params = JSON.stringify(
            {
                Type: "Role"
            });
        $.ajax({
            url: GetglobalDomain()+ "/Role/FillDepartmentandGroupMaster",
            type: 'POST',
            dataType: "json",
            contentType: "application/json",
            data: Params,
            success: function (response) {

                debugger;


                for (var i = 0; i < response.Data.length; i++) {
                    @*if ('@GroupId' == response.Data[i].Id && Id == Ids) {
                        strHTML += "<option value='" + response.Data[i].Id + "' Selected>" + response.Data[i].Text + "</option>"
                    }
                    else {
                    }*@
                    strHTML += "<option value='" + response.Data[i].Id + "'>" + response.Data[i].Text + "</option>"
                }
                $("#RoleId").select2("destroy");
                $("#RoleId").html(strHTML);
                $("#RoleId").select2();
                //$("#RoleId").select2("destroy");
                //$("#RoleId").html('Select Role');
                //$("#RoleId").select2();


            }
        });



    }
    function BindTehsil(DistID) {
        debugger;
        var strHTML = "";


        var Params = JSON.stringify(
            {
                distID: parseInt(DistID)
            });
        $.ajax({
            url: GetglobalDomain() + "/Role/GetTehsil",
            type: 'POST',
            dataType: "json",
            contentType: "application/json",
            data: Params,
            success: function (response) {
                strHTML = "<option value='0'>Select Tehsil</option>";
                for (var i = 0; i < response.Data.length; i++) {
                   
                    strHTML += "<option value='" + response.Data[i].Id + "'>" + response.Data[i].Text + "</option>"
                }
                //$("#ddltehsil").select2("destroy");
                $("#ddltehsil").html(strHTML);
                $("#ddltehsil").select2();
                //$("#RoleId").select2("destroy");
                //$("#RoleId").html('Select Role');
                //$("#RoleId").select2();


            }
        });



    }

</script>